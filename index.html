<!doctype html>
<html>
<head>
	<title>JS Games by Michael Wu</title>
	<script type="text/javascript" src="jquery-2.2.4.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<link rel="stylesheet" href="bootstrap-3.3.6-dist/css/bootstrap.min.css">
	<script src="bootstrap-3.3.6-dist/js/bootstrap.min.js"></script>
	<link rel="stylesheet" href="bootstrap-select-1.10.0/dist/css/bootstrap-select.min.css">
	<script src="bootstrap-select-1.10.0/dist/js/bootstrap-select.min.js"></script>
	<link rel="stylesheet" href="main.css">
</head>
<body>
	<div id="container">
		<div id="name_select" class="box">
			<div> What should we call you? </div>
			<input type="text" maxlength="12" id="input_name" />
			<div id="name_select_msg" class="msg alert"></div>
		</div>

		<div id="chatmain" class="box">
			<div class="panel panel-default">
				<div class="panel-heading">Chat</div>
				<div class="panel-body">
					<ul id="messages"></ul>
					<div class="input-group">
						<span class="input-group-addon" id="chatname">Username:</span>
						<input autocomplete="off" class="form-control" type="text" id="chatbox_main_msg" placeholder="Enter message..."/>
					</div>
				</div>
			</div>
		</div>

		<div id="gameroombox" class="box contentbox">
			Game rooms
			<div class="table-responsive">
				<table class="table" id="gameroomtable">
					<thead><tr>
						<th width="10%">Room #</th>
						<th width="30%">Room Name</th>
						<th width="20%">Game</th>
						<th width="30%">Players</th>
						<th width="10%">Join</th>
					</tr></thead>
					<tbody>
						<tr id="placeholder"><td colspan="5">No games to display</td></tr>
					</tbody>
				</table>
			</div>
		</div>

		<div id="creategamebox" class="box">
		<!--
		<div class="input-group input-group-lg" id="joingamenum">
			<span class="input-group-addon">Join a Room</span>
			<input autocomplete="off" class="form-control" type="text" id="joinroomnum" placeholder="Room # and press Enter"/>
		</div>
	-->		
	<a class="btn btn-success" href="#" role="button" id="create_room_button">Create a Room</a>
</div>

<div class="box" id="onlinebox">
	<div class="panel panel-default">
		<div class="panel-heading">
			<span class="text">Online</span><span class="badge" id="numonline">0</span>
		</div>
		<div class="panel-body">
			<div id="onlinelist"></div>
		</div>
	</div>
</div>

<div class="box" id="dim_div">

</div>

<div id="create_room_box" class="box">
	<a href="#" id="close_btn" class="btn btn-default">&times;</a>
	<div class="panel panel-default" id="create_room_panel">
		<div class="panel-heading">Create a Room</div>
		<div class="panel-body">
			<div class="row"><!--Placeholder--></div>
			<div class="row">
				<div class="input-group input-group-lg">
					<span class="input-group-addon">Room Name</span>
					<input type="text" class="form-control" placeholder="Required" aria-describedby="basic-addon1" id="create_room_name" maxlength="20">
				</div>
			</div>
			<div class="row">
				<div class="input-group input-group-lg">
					<span class="input-group-addon glyphicon glyphicon-lock"></span>
					<input type="password" class="form-control" placeholder="Optional" aria-describedby="basic-addon1" id="create_room_pw" maxlength="20">
				</div>
			</div>
			<div class="row">
				<div class="col-md-6">
					<select class="selectpicker form-control col-lg-12" title="Choose a Game" id="create_game_type">
						<option value="Connect Four">Connect Four</option>
						<option value="Checkers">Checkers</option>
						<option value="Uno">Uno</option>
						<option value="Chess">Chess</option>
					</select>
				</div>
				<div class="col-md-6">
					<select class="selectpicker form-control col-lg-12" title="Number of Players" id="create_num_players">
						<option disabled>Please select a game first</option>
					</select>
				</div>
			</div>
			<div class="row">
				<a class="btn btn-success" href="#" role="button" id="create_room_button2">Create Room</a>
				<div class="progress" id="loading">
				  <div class="progress-bar progress-bar-success progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
				  </div>
				</div>
			</div>
			<div class="row"><!--Placeholder--></div>
		</div>
	</div>
	<div class="msg alert alert-danger" id="createmsg">Create message</div>
</div>

<div id="connect_four_div" class="box">
	<div id="opponent" class="label label-default">Waiting for opponent...</div>
	<div id="connect_four_board">
		<div class="row c4row">
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
		</div>
		<div class="row c4row">
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
		</div>
		<div class="row c4row">
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
		</div>
		<div class="row c4row">
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
		</div>
		<div class="row c4row">
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
		</div>
		<div class="row c4row">
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
			<div class="col-md-1 c4box"></div>
		</div>
	</div>
	<div id="me" class="label label-default">Me</div>
</div>

</div>
<script type="text/javascript">
//Variables
var socket = io();
var usrname = false;
var myColor;
var colors = {}
colors["#337AB7"] = "primary";
colors["#5CB85C"] = "success";
colors["#5BC0DE"] = "info";
colors["#F0AD4E"] = "warning";
colors["#D9534F"] = "danger";

var gameRooms = {};
gameRooms.active = 0;

var makeRoomStatus = false;

//Server com for logging in
function attemptLogin(picked_name){
	usrname = picked_name;
	socket.emit('pickname', usrname);
}

//Login code, moving to selection 
socket.on('login status', function(status){
	if(status==1){
		//Name select goes away
		$("#name_select").animate({
			left: '-100%'
		}, 500);

		//Chat box comes in
		$("#chatmain").animate({
			left: '105%'
		}, 500);

		//Game roomes come in
		$("#gameroombox").animate({
			left: '42.5%'
		}, 500);

		//Create room/join number comes in
		$("#creategamebox").animate({
			left: '47%'
		}, 500);

		//Who's online comes in
		$("#onlinebox").animate({
			left: '25%'
		}, 500);

		//Set chatbox username
		$("#chatname").text(usrname+":");

		//Give user a random color
		var cols = ['#337AB7', '#5CB85C', '#5BC0DE', '#F0AD4E', '#D9534F'];
		myColor = cols[Math.floor(Math.random()*cols.length)];

		//send color
		socket.emit('choosecolor', myColor);
		$("#chatname").addClass('label-'+colors[myColor]);
		socket.emit('joinchatroom', 'main');

	}else if(status==0){
		//already taken
		usrname = false;
		var msg = $("#name_select_msg");
		msg.addClass('alert-danger');
		msg.text('That username is already taken!');
		msg.fadeIn().delay(1000).fadeOut("slow");

	}
});

//main chatroom receiving
socket.on('message2c', function(msg){
	if(!usrname){
		return false;
	}
	var received = JSON.parse(msg);
	//handle here
	//replace me
	var msgbox = $('#messages');
	var scrollBottom = false;

	if(msgbox[0].scrollHeight-msgbox.scrollTop()==msgbox.outerHeight()){
		scrollBottom = true;
	}

	var adiv = $("<div>");
	var aspan = $("<span style='color:"+received.color+";font-weight:bold'>").text(received.user+": ");
	adiv.append(aspan);
	var ali = $('<span>').text(received.content);
	adiv.append(ali);

	msgbox.append(adiv);
	if(scrollBottom){
		$('#messages').scrollTop($('#messages')[0].scrollHeight);
	}

});

//updating online users
socket.on('onlineUsers', function(msg){
	var received = JSON.parse(msg);
	var list = $("#onlinelist");
	list.empty();
	for(var i=0;i<received[0].length;i++){
		list.append($("<span>").css('color',received[1][i]).text(received[0][i]));
	}
	$("#numonline").text(received[0].length);
});

//updating chat when user joins
socket.on('userJoinMainChat', function(username){
	var txt = username;
	if(username==usrname){
		txt+=" (You)";
	}
	txt+=" joined the room";
	$("#messages").append($("<div class='subtle'>").text(txt));
});

//updating chat when user leaves; TODO: Make this apply for all chats
socket.on('userDisconnect', function(username){
	var txt = username+" left the room";
	$("#messages").append($("<div class='subtle'>").text(txt));
});

//response from making room
socket.on('makeRoomResponse', function(code){
	if(makeRoomStatus){
		makeRoomStatus = false;
		$("#loading").hide();
		$("#create_room_button2").show();
		if(code==0){
			//Server error
			$("#createmsg").text("There was a problem creating the room");
			$("#createmsg").fadeIn().delay(1000).fadeOut("slow");
		}else if(code==1){
			//Success
			console.log("Made room successfully")
			$("#close_btn").click();
		}
	}
});

//add a room to the list of available rooms
function addRoom(room){
	var tr = $("<tr>");
	tr.append($("<td>").text(room.id));
	tr.append($("<td>").text(room.name));
	tr.append($("<td>").text(room.game));
	tr.append($("<td>").text(room.players));
	tr.append($("<td>").text("Join"));
	gameRooms[room.id] = tr;
	gameRooms.active++;
	$('#gameroomtable > tbody:last-child').append(tr);
	//$("#placeholder").css('display', 'none');
	$("#placeholder").hide();
}
//remove a room from the list
function removeRoom(roomId){
	gameRooms[roomId].remove();
	gameRooms.active--;
	if(gameRooms.active==0){
		//$("#placeholder").css('display', 'inline');
		$("#placeholder").show();
	}
}


//Client JS Code

//Name picking
$("#input_name").bind('keypress', function(e){
	if(e.which==13 && this.value!="" && usrname==false){
		attemptLogin(this.value);
	}
}).on('input', function(e){
	this.value = this.value.replace(/[^A-Za-z0-9]/g, '');
});

//Sending messages in main chat
$("#chatbox_main_msg").bind('keypress', function(e){
	if(e.which==13 && this.value.trim()!="" && usrname!=false){
		var m = new Object();
		m.chatroom = "main";
		m.message = this.value
		m.color = myColor;
		socket.emit('message2s', JSON.stringify(m));
		this.value="";
	}
});

//bring up creating room screen
$("#create_room_button").click(function(){
	$("#dim_div").css('left', '25%');
	$("#dim_div").css('background-color','rgba(0,0,0,0.9)')
	$("#create_room_box").animate({
		left: '31%'
	}, 500);

});

//close creating room screen
$("#close_btn").click(function(){
	$("#create_room_box").animate({
		left: '125%'
	}, 500, function(){
		$("#dim_div").css('left', '125%');
		$("#dim_div").css('background-color','rgba(0,0,0,0)')
	});
});

//Send create room message to server

$("#create_room_button2").click(function(){
	if(makeRoomStatus){
		return false;
	}
	var room = Object();
	room.name = $("#create_room_name").val().trim();
	room.pw = $("#create_room_pw").val().trim();
	room.gameType = $("#create_game_type").val();
	room.numPlayers = $("#create_num_players").val();
	var error = "";
	//validate
	if(!(room.name.length>20) && room.name.length>0 && validChars(room.name)){
		if(!(room.pw.length>20) && validChars(room.pw)){
			if(!(room.gameType.length==0) && !(room.numPlayers.length==0)){
				socket.emit('makeRoom', JSON.stringify(room));
				makeRoomStatus = true;
				$("#create_room_button2").hide();
				$("#loading").show();
			}else{
				error = "Please select a game/players.";
			}
		}else{
			error = "Invalid room password!";
		}
	}else{
		error = "Invalid room name!";
		console.log(room.name);
	}

	if(error!=""){
		$("#createmsg").text(error);
		$("#createmsg").fadeIn().delay(1000).fadeOut("slow");
	}
});

function validChars(str){
	//TODO: IMPLEMENT ME
	return true;
}

//Populating the num players in create game menu
var game_players = {};
game_players["Connect Four"] = [2];
game_players["Chess"] = [2];
game_players["Uno"] = [2,3,4];
game_players["Checkers"] = [2];
$("#create_game_type").change(function(){
	var possible = game_players[$("#create_game_type").val()];
	var list = $("#create_num_players");
	list.empty();
	for(var i=0;i<possible.length;i++){
		list.append($("<option>").text(possible[i]));
	}
	list.selectpicker('refresh');
});

/*
//Clicking on "connect four"
$("#select_connect4").click(function(){
	resizeC4();
	activeView = "Connect Four";
	//Replace me with room id
	socket.emit('join', 'Connect Four');
	$("#selectbox").animate({
		left: '-50%'
	}, 500);
	$("#connect_four_div").animate({
		left: '40%'
	}, 500);
});
*/
//Misc chatbox focus
/*
$("#messages").click(function(){
	$("#chatbox_main_msg").focus();
});
*/
/*
//Misc chatbox hover, todo: move to css
$(".list-group-item").hover(
	function(){$(this).addClass('active')},
	function(){$(this).removeClass('active')}
	);

//Correcting size for the connect 4 window.
function resizeC4(){
	var setTo = $(".c4box").width();
	$(".c4row").height(setTo);
}

$(window).resize(function(){
	if(activeView=="Connect Four"){
		resizeC4();
	}
})
*/
$(document).ready(function(){
	$("#name_select").fadeIn(2000);
	$("#input_name").focus();
});
</script>
</body>
</html>