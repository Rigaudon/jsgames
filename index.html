<!doctype html>
<html>
<head>
	<title>JS Games by Michael Wu</title>
	<link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
	<script type="text/javascript" src="jquery-2.2.4.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  	<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
	<link rel="stylesheet" href="main.css">
</head>
<body>
	<div id="container">
		<div id="name_select" class="box">
			<div> What should we call you? </div>
			<input type="text" maxlength="12" id="input_name" />
			<div id="name_select_msg" class="msg alert alert-dismissible"></div>
		</div>

		<div id="chatmain" class="box">
			<div class="panel panel-default">
			<div class="panel-heading">Chat</div>
			<div class="panel-body">
			<ul id="messages"></ul>
			<div class="input-group">
				<span class="input-group-addon" id="chatname">Username:</span>
				<input autocomplete="off" class="form-control" type="text" id="chatbox_main_msg" placeholder="Enter message..."/>
			</div>
			</div>
			</div>
		</div>

		<div id="gameroombox" class="box contentbox">
			Game rooms
			<div class="table-responsive">
				<table class="table" id="gameroomtable">
					<thead><tr>
						<th width="10%">Room #</th>
						<th width="30%">Room Name</th>
						<th width="20%">Game</th>
						<th width="30%">Players</th>
						<th width="10%">Join</th>
					</tr></thead>
					<tbody>
					<tr id="placeholder"><td colspan="5">No games to display</td></tr>
					</tbody>
				</table>
			</div>
		</div>

		<div id="creategamebox" class="box">
		<!--
		<div class="input-group input-group-lg" id="joingamenum">
			<span class="input-group-addon">Join a Room</span>
			<input autocomplete="off" class="form-control" type="text" id="joinroomnum" placeholder="Room # and press Enter"/>
		</div>
		-->		
		<a class="btn btn-success" href="#" role="button" id="create_room_button">Create a Room</a>
		</div>

		<div class="box" id="onlinebox">
		<div class="panel panel-default">
		<div class="panel-heading">
		<span class="text">Online</span><span class="badge" id="numonline">0</span>
		</div>
		<div class="panel-body">
		<div id="onlinelist"></div>
		</div>
		</div>
		</div>

		<div class="box" id="dim_div">
		
		</div>

		<div id="create_room_box" class="box">
		<a href="#" id="close_btn" class="btn btn-default">Close</a>
		<div class="panel panel-default" id="create_room_panel">
		<div class="panel-heading">Create a Room</div>
		<div class="panel-body">Body</div>
		</div>
		</div>

		<div id="connect_four_div" class="box">
			<div id="opponent" class="label label-default">Waiting for opponent...</div>
			<div id="connect_four_board">
				<div class="row c4row">
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
				</div>
				<div class="row c4row">
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
				</div>
				<div class="row c4row">
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
				</div>
				<div class="row c4row">
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
				</div>
				<div class="row c4row">
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
				</div>
				<div class="row c4row">
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
				</div>
			</div>
			<div id="me" class="label label-default">Me</div>
		</div>

	</div>
	<script type="text/javascript">
//Variables
var socket = io();
var usrname = false;
var myColor;
var colors = {}
colors["#337AB7"] = "primary";
colors["#5CB85C"] = "success";
colors["#5BC0DE"] = "info";
colors["#F0AD4E"] = "warning";
colors["#D9534F"] = "danger";
var gameRooms = {};
gameRooms.active = 0;

//Server com for logging in
function attemptLogin(picked_name){
	usrname = picked_name;
	socket.emit('pickname', usrname);
}

//Login code, moving to selection 
socket.on('login status', function(status){
	if(status==1){
		//Name select goes away
		$("#name_select").animate({
			left: '-100%'
		}, 500);

		//Chat box comes in
		$("#chatmain").animate({
			left: '105%'
		}, 500);

		//Game roomes come in
		$("#gameroombox").animate({
			left: '42.5%'
		}, 500);

		//Create room/join number comes in
		$("#creategamebox").animate({
			left: '47%'
		}, 500);

		//Who's online comes in
		$("#onlinebox").animate({
			left: '25%'
		}, 500);

		//Set chatbox username
		$("#chatname").text(usrname+":");

		//Give user a random color
		var cols = ['#337AB7', '#5CB85C', '#5BC0DE', '#F0AD4E', '#D9534F'];
		myColor = cols[Math.floor(Math.random()*cols.length)];

		//send color
		socket.emit('choosecolor', myColor);
		$("#chatname").addClass('label-'+colors[myColor]);
		socket.emit('joinchatroom', 'main');

	}else if(status==0){
		//already taken
		usrname = false;
		var msg = $("#name_select_msg");
		msg.addClass('alert-danger');
		msg.text('That username is already taken!');
		msg.fadeIn().delay(1000).fadeOut("slow");
	}
});

//main chatroom receiving
socket.on('message2c', function(msg){
	if(!usrname){
		return false;
	}
	var received = JSON.parse(msg);
	//handle here
	//replace me
	var msgbox = $('#messages');
	var scrollBottom = false;

	if(msgbox[0].scrollHeight-msgbox.scrollTop()==msgbox.outerHeight()){
		scrollBottom = true;
	}

	var adiv = $("<div>");
	var aspan = $("<span style='color:"+received.color+";font-weight:bold'>").text(received.user+": ");
	adiv.append(aspan);
	var ali = $('<span>').text(received.content);
	adiv.append(ali);

	msgbox.append(adiv);
	if(scrollBottom){
		$('#messages').scrollTop($('#messages')[0].scrollHeight);
	}

});

//updating online users
socket.on('onlineUsers', function(msg){
	var received = JSON.parse(msg);
	var list = $("#onlinelist");
	list.empty();
	for(var i=0;i<received[0].length;i++){
		list.append($("<span>").css('color',received[1][i]).text(received[0][i]));
	}
	$("#numonline").text(received[0].length);
});

//updating chat when user joins
socket.on('userJoinMainChat', function(username){
	var txt = username;
	if(username==usrname){
		txt+=" (You)";
	}
	txt+=" joined the room";
	$("#messages").append($("<div class='subtle'>").text(txt));
});

//updating chat when user leaves; TODO: Make this apply for all chats
socket.on('userDisconnect', function(username){
	var txt = username+" left the room";
	$("#messages").append($("<div class='subtle'>").text(txt));
});

//add a room to the list of available rooms
function addRoom(room){
	var tr = $("<tr>");
	tr.append($("<td>").text(room.id));
	tr.append($("<td>").text(room.name));
	tr.append($("<td>").text(room.game));
	tr.append($("<td>").text(room.players));
	tr.append($("<td>").text("Join"));
	gameRooms[room.id] = tr;
	gameRooms.active++;
	$('#gameroomtable > tbody:last-child').append(tr);
	$("#placeholder").css('display', 'none');
}
//remove a room from the list
function removeRoom(roomId){
	gameRooms[roomId].remove();
	gameRooms.active--;
	if(gameRooms.active==0){
		$("#placeholder").css('display', 'inline');
	}
}


//Client JS Code

//Name picking
$("#input_name").bind('keypress', function(e){
	if(e.which==13 && this.value!="" && usrname==false){
		attemptLogin(this.value);
	}
}).on('input', function(e){
	this.value = this.value.replace(/[^A-Za-z0-9]/g, '');
});

//Sending messages in main chat
$("#chatbox_main_msg").bind('keypress', function(e){
	if(e.which==13 && this.value.trim()!="" && usrname!=false){
		var m = new Object();
		m.chatroom = "main";
		m.message = this.value
		m.color = myColor;
		socket.emit('message2s', JSON.stringify(m));
		this.value="";
	}
});

//bring up creating room screen
$("#create_room_button").click(function(){
	$("#dim_div").css('left', '25%');
	$("#dim_div").css('background-color','rgba(0,0,0,0.9)')
	$("#create_room_box").animate({
		left: '31%'
	}, 500);

});

//close creating room screen
$("#close_btn").click(function(){
	$("#create_room_box").animate({
		left: '125%'
	}, 500, function(){
		$("#dim_div").css('left', '125%');
		$("#dim_div").css('background-color','rgba(0,0,0,0)')
	});
});

/*
//Clicking on "connect four"
$("#select_connect4").click(function(){
	resizeC4();
	activeView = "Connect Four";
	//Replace me with room id
	socket.emit('join', 'Connect Four');
	$("#selectbox").animate({
		left: '-50%'
	}, 500);
	$("#connect_four_div").animate({
		left: '40%'
	}, 500);
});
*/
//Misc chatbox focus
/*
$("#messages").click(function(){
	$("#chatbox_main_msg").focus();
});
*/
/*
//Misc chatbox hover, todo: move to css
$(".list-group-item").hover(
	function(){$(this).addClass('active')},
	function(){$(this).removeClass('active')}
	);

//Correcting size for the connect 4 window.
function resizeC4(){
	var setTo = $(".c4box").width();
	$(".c4row").height(setTo);
}

$(window).resize(function(){
	if(activeView=="Connect Four"){
		resizeC4();
	}
})
*/
$(document).ready(function(){
	$("#name_select").fadeIn(2000);
	$("#input_name").focus();
});
</script>
</body>
</html>