<!doctype html>
<html>
<head>
	<title>JS Games by Michael Wu</title>
	<link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
	<script type="text/javascript" src="jquery-2.2.4.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
	<link rel="stylesheet" href="main.css">
</head>
<body>
	<div id="container">
		<div id="name_select" class="box">
			<div> What should we call you? </div>
			<input type="text" maxlength="12" id="input_name" />
			<div id="name_select_msg" class="msg alert"></div>
		</div>

		<div id="selectbox" class="box">
			<h1>Select a game</h1>
			<div class="list-group">
				<a href="#" id="select_connect4" class="list-group-item">Connect Four</a>
				<a href="#" class="list-group-item">Checkers</a>
				<a href="#" class="list-group-item">Uno</a>
				<a href="#" class="list-group-item">Chess</a>

			</div>
		</div>

		<div id="connect_four_div" class="box">
			<div id="opponent" class="label label-default">Waiting for opponent...</div>
			<div id="connect_four_board">
				<div class="row c4row">
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
				</div>
				<div class="row c4row">
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
				</div>
				<div class="row c4row">
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
				</div>
				<div class="row c4row">
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
				</div>
				<div class="row c4row">
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
				</div>
				<div class="row c4row">
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
					<div class="col-md-1 c4box"></div>
				</div>
			</div>
			<div id="me" class="label label-default">Me</div>
		</div>

		<div id="chatbox" class="box">
			<h1>Chat</h1>
			<ul id="messages"></ul>
			<div class="input-group input-group-lg">
				<span class="input-group-addon label-primary" id="chatname">Username:</span>
				<input autocomplete="off" class="form-control" type="text" id="chatbox_main_msg" placeholder="Enter message..."/>
			</div>
		</div>

	</div>
	<script type="text/javascript">
//Variables
var socket = io();
var usrname = false;
var activeView = "Login";
//Can be: Login, Selection Menu, Connect Four
var chatLastUser = "";

//Server com for logging in
function attemptLogin(picked_name){
	usrname = picked_name;
	socket.emit('pickname', usrname);
}

//Login code, moving to selection 
socket.on('login status', function(status){
	if(status==1){
		$("#name_select").animate({
			left: '-100%'
		}, 500);

		$("#selectbox").animate({
			left: '40%'
		}, 500);

		$("#chatbox").animate({
			left: '101%'
		}, 500);
		activeView = "Selection Menu";
		$("#chatname").text(usrname+":");
	}else if(status==0){
		//already taken
		usrname = false;
		var msg = $("#name_select_msg");
		msg.addClass('alert-danger');
		msg.text('That username is already taken!');
		msg.fadeIn();
	}
});

//main chatroom
socket.on('message2c', function(msg){
	var received = JSON.parse(msg);
	//handle here
	//replace me
	var msgbox = $('#messages');
	var scrollBottom = false;

	if(msgbox[0].scrollHeight-msgbox.scrollTop()==msgbox.outerHeight()){
		scrollBottom = true;
	}
	var adiv = $("<div>");
	if(received.user!=chatLastUser){
		var aspan = $("<h3>").append($("<span class='label label-primary'>").text(received.user));
		adiv.append(aspan);
		chatLastUser = received.user;
	}
	var ali = $('<li class="list-group-item">').text(received.content);
	adiv.append(ali);

	msgbox.append(adiv);
	if(scrollBottom){
		$('#messages').scrollTop($('#messages')[0].scrollHeight);
	}

});

//Connect Four receiving from server
socket.on('c4gamestate', function(msg){
	if(msg=='waiting'){
		$("#me").text(usrname+" (Me)");
	}
});
socket.on('c4opponent_name', function(msg){
	$("#opponent").text(msg);
});

//Client JS Code

//Name picking
$("#input_name").bind('keypress', function(e){
	if(e.which==13 && this.value!="" && usrname==false){
		attemptLogin(this.value);
	}
}).on('input', function(e){
	this.value = this.value.replace(/[^A-Za-z0-9]/g, '');
});

//Sending messages in main chat
$("#chatbox_main_msg").bind('keypress', function(e){
	if(e.which==13 && this.value.trim()!="" && usrname!=false){
		var m = new Object();
		m.chatroom = "main";
		m.message = this.value
		socket.emit('message2s', JSON.stringify(m));
		this.value="";
	}
});

//Clicking on "connect four"
$("#select_connect4").click(function(){
	resizeC4();
	activeView = "Connect Four";
	//Replace me with room id
	socket.emit('join', 'Connect Four');
	$("#selectbox").animate({
		left: '-50%'
	}, 500);
	$("#connect_four_div").animate({
		left: '40%'
	}, 500);
});

//Misc chatbox focus
/*
$("#messages").click(function(){
	$("#chatbox_main_msg").focus();
});
*/

//Misc chatbox hover, todo: move to css
$(".list-group-item").hover(
	function(){$(this).addClass('active')},
	function(){$(this).removeClass('active')}
	);

//Correcting size for the connect 4 window.
function resizeC4(){
	var setTo = $(".c4box").width();
	$(".c4row").height(setTo);
}

$(window).resize(function(){
	if(activeView=="Connect Four"){
		resizeC4();
	}
})

$(document).ready(function(){
	$("#name_select").fadeIn(2000);
});
</script>
</body>
</html>